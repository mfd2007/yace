import Component from '../lib/component.js';
import store from '../store/index.js';

export default class NotesList extends Component {
    
    vulnerabilityId = "";
    
    // Pass our store instance and the HTML element up to the parent Component
    constructor(selector, vulnerabilityId) {
        super({
            store,
            element: document.querySelector(selector)
        });
        this.vulnerabilityId = vulnerabilityId;
    }

    /**
     * React to state changes and render the component's HTML
     *
     * @returns {void}
     */
    render() {
        let self = this;

        // If there are no items to show, render a little status instead
        if((store.state.csaf?.vulnerabilities == undefined) ||
           (store.state.csaf?.vulnerabilities.length < this.vulnerabilityId) ||
           (store.state.csaf?.vulnerabilities[this.vulnerabilityId].notes == undefined))
        {
          self.element.innerHTML = `
            <ul class="w3-ul">
              <li><h3>Notes</h3></li>
              <li>
                <button id="add_vul_notes" class="w3-button w3-block w3-green">Add note</button>
              </li>
            </ul>
         `;
        }else {
        // Loop the items and generate a list of elements
          self.element.innerHTML = `
            <ul class="w3-ul">
              <li><h3>Notes</h3></li>
                ${store.state.csaf.vulnerabilities[this.vulnerabilityId].notes?.map((notesItem, index) => {
                    return `
                        <li class="w3-container">
                          <div class="w3-row">
                            <label for="vulnerabilities.${this.vulnerabilityId}.notes.${index}.title">Title</label>
                            <input class="w3-input" id="vulnerabilities.${this.vulnerabilityId}.notes.${index}.title" type="text" value="${(notesItem.title != undefined) ? notesItem.title:''}" />
                            <label for="vulnerabilities.${this.vulnerabilityId}.notes.${index}.text">Text</label>
                            <input class="w3-input" id="vulnerabilities.${this.vulnerabilityId}.notes.${index}.text" type="text" value="${(notesItem.text != undefined) ? notesItem.text:''}" />
                            <label for="vulnerabilities.${this.vulnerabilityId}.notes.${index}.category">Category</label>
                            <select id="vulnerabilities.${this.vulnerabilityId}.notes.${index}.category" class="w3-select yace-notes">
                              <option value="">Choose your option</option>
                              <option value="description" ${(notesItem?.category != undefined && notesItem?.category == "description")?'selected':''}>description</option>
                              <option value="details" ${(notesItem?.category != undefined && notesItem?.category == "details")?'selected':''}>details</option>
                              <option value="faq" ${(notesItem?.category != undefined && notesItem?.category == "faq")?'selected':''}>faq</option>
                              <option value="general" ${(notesItem?.category != undefined && notesItem?.category == "general")?'selected':''}>general</option>
                              <option value="legal_disclaimer" ${(notesItem?.category != undefined && notesItem?.category == "legal_disclaimer")?'selected':''}>legal_disclaimer</option>
                              <option value="other" ${(notesItem?.category != undefined && notesItem?.category == "other")?'selected':''}>other</option>
                              <option value="summary" ${(notesItem?.category != undefined && notesItem?.category == "summary")?'selected':''}>summary</option>
                            </select> 
                            <button id="remove_vul_notes" class="w3-button w3-transparent" aria-label="Delete this item">&times</button>
                            </div>
                          </div>
                        </li>
                    `
                }).join('')}
                <li>
                  <button id="add_vul_notes" class="w3-button w3-block w3-green">Add note</button>
                </li>
            </ul>
        `;
        }
        // Add a submit event listener to the form and prevent it from posting back
        self.element.querySelectorAll('#add_vul_notes').forEach((button) => {
          button.addEventListener('click', () => {
            store.dispatch('addVulNotes', {"vulId": this.vulnerabilityId});
          });
        });
        
        // Find all the buttons in the list and when they are clicked, we dispatch a 
        // `clearItem` action which we pass the current item's index to
        self.element.querySelectorAll('#remove_vul_notes').forEach((button, index) => {
            button.addEventListener('click', () => {
                store.dispatch('removeVulNotes', { "vulId": this.vulnerabilityId, "index": index });
            });
        });
        
        self.element.querySelectorAll("input[type=\"text\"]").forEach((element) => {
            element.addEventListener('change', () => {
                store.dispatch('setItem', { path: element.id, value: element.value});
            });
        });
        
        self.element.querySelectorAll("select.yace-notes").forEach((element) => {
            element.addEventListener('change', () => {
                store.dispatch('setItem', { path: element.id, value: element.value});
            });
        });

    }
};
